<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yu-Gi-Oh</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
    <link type="text/css" rel="stylesheet" href="YGO.css">
</head>
<body>
    <header>
        <div class="search">
            <div>
                <input type="text" placeholder="請輸入名稱(英文)" value="baby dragon"/><button onClick="Search()">搜尋</button>

            </div>    
        </div>
        <div class="nav">
            <a href="#">牌組列表</a>
        </div>
    </header>

    <section id="overview">
        <div class="layout explorer"></div>
        <div class="layout deck" style="display:none;">牌組</div>
    </section>

    <sectiom id="check-more">
        
    </sectiom>

    <section class="popup">
        <div class="card-info">
            <div id="card-img">
                <img id="zoomin-img" src="https://ygoprodeck.com/pics/back_high.jpg">
            </div>
            <div id="card-description">
                <h1 id="card-name">card name <img id="attribute" src="https://ygoprodeck.com/pics/EARTH.jpg"></h1>
                <div id="card-ad">
                    <span class="level"><img style="max-height: 20px; margin-top: 5px;" src="https://ygoprodeck.com/wp-content/uploads/2017/01/level.png" /><p></p></span>
                    <span class="atkdef"></span>
                </div>
                <div id="card-type">

                </div>
                <div id="card-desc">
                </div>
                <div id="archetype">

                </div>                
            </div>
        </div>
        <div class="close"><i class="bi bi-x-lg" onclick="ZoomOut()" title="關閉"></i></div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        let input = document.getElementsByTagName('input');
        const cardExplorer = document.getElementsByClassName('explorer');
        const checkmore = document.getElementById('check-more');

        const levelicon = "https://ygoprodeck.com/wp-content/uploads/2017/01/level.png";

        //TODO:API的response結果 寫一個Objlist存response的資料 可以用overview中的image id來找卡片的資訊
        let cardInfo;

        //遊戲王API url
        const url = 'https://db.ygoprodeck.com/api/v7/cardinfo.php';

        const Search = ()=>{
            const searchName = input[0].value.trim();
            console.log(searchName.length);
            if(searchName === '' || searchName.length < 3){
                alert('請輸入有效關鍵字');
                return;
            }
            getCardImage(url + '?fname=' + searchName);
        };

        //更多卡片結果
        let maxnumber = 0;
        const cardspertime = 36;


        //TODO 過濾器 種族 星 魔/陷 攻/防
        let done = false;
        async function getCardImage(URL) {
            if(done) return;
            //刷新頁面
            done = true;
            cardExplorer[0].innerHTML = "";
            cardInfo = [];
            maxnumber = 0;
            $('#more-result').remove();

            let myObject = await fetch(URL);
            console.log(myObject.status);
            if(myObject.status != 200){
                alert(myObject.status + " Bad Request");
                done = false;
                return;
            }

            let myText = await myObject.text();
            const json = await JSON.parse(myText);
            //TODO:json處理 cardInfo為已搜尋完的結果(全部)
            cardInfo = json.data;
            console.log(cardInfo);
            let number = 0;

            await cardInfo.forEach(card => {
                //為預防效能降低 先取出部分數量結果(cardspertime)
                if(number >= cardspertime){
                    maxnumber = number;
                    return;
                }
                cardExplorer[0].innerHTML += "<img width='10%' id = " + number + " name=" + number++ +" src=" + card.card_images[0].image_url_small + " onclick='ZoomIn(name)'>";
            })

            if(maxnumber >= 36){
                checkmore.innerHTML = "<button id='more-result' onclick='MoreResult(maxnumber)'>顯示更多結果...</button>";
            }
            done = false;
        }

        //更多結果方法
        const MoreResult = (number)=>{

            $('#more-result').remove();
            let checknumber = number+cardspertime;

            for(number; number<cardInfo.length; number++){
                if(number >= checknumber) break;
                $("<img width='10%' id = " + number + " name=" + number +" src=" + cardInfo[number].card_images[0].image_url_small + " onclick='ZoomIn(name)'>").appendTo($('.explorer'));
            }
            maxnumber = number;
            if(maxnumber < cardInfo.length){
                checkmore.innerHTML = "<button id='more-result' onclick='MoreResult(maxnumber)'>顯示更多結果...</button>";
            }
        };

        //檢視卡牌
        const ZoomIn = (id)=>{
            const cardinfo = $('.popup').children('.card-info');

            $('#card-img').children('img').prop('src', cardInfo[id].card_images[0].image_url);

            $('#attribute').remove();
            $('#card-name').text(cardInfo[id].name);
            if(cardInfo[id].type != "Spell Card" && cardInfo[id].type != "Trap Card")
                $('#card-name').append('<img id="attribute" src="https://ygoprodeck.com/pics/' + cardInfo[id].attribute + '.jpg">');

            if(cardInfo[id].level != null){
                $('#card-ad').css('display', 'flex');
                $('#card-ad').children('.level').css('display', 'flex');
                $('#card-ad').children('.level').children('p').text(cardInfo[id].level);
            }else if(cardInfo[id].type != "Spell Card" && cardInfo[id].type != "Trap Card"){
                $('#card-ad').css('display', 'flex');
                $('#card-ad').children('.level').css('display', 'none');
            }else{
                $('#card-ad').css('display', 'none');
            }
                
            if(cardInfo[id].atk != null){
                if(cardInfo[id].type == 'Link Monster'){
                    $('#card-ad').children('.atkdef').text('');
                    $('#card-ad').children('.atkdef').append("ATK/ "+ cardInfo[id].atk + "<strong id='link-type'>LINK-" + cardInfo[id].linkval + "</strong>");
                }else{
                    $('#card-ad').children('.atkdef').text('');
                    $('#card-ad').children('.atkdef').append("ATK/"+ cardInfo[id].atk + "<span id='def'>DEF/" + cardInfo[id].def + "</span>");
                }
            }else{
                $('#card-ad').children('.atkdef').text('');
            }

            $('#card-type').text(cardInfo[id].type + " / " + cardInfo[id].race);

            $('#card-desc').text(cardInfo[id].desc);
            
            if(cardInfo[id].archetype != null)
                $('#archetype').css('display', 'block').text("Archetype: " + cardInfo[id].archetype);
            else
                $('#archetype').css('display', 'none');

            $('.popup').css('display','flex');
        };

        //關閉檢視
        const ZoomOut = ()=>{
            $('#card-img').children('img').prop('src', 'https://ygoprodeck.com/pics/back_high.jpg');
            $('#link-type').remove();
            $('#def').remove();
            $('.popup').css('display','none');
        }
    </script>
</body>
</html>